---
layout: post
title: kubernetes TLS bootstrap
<!-- subtitle: -->
date: 2020-10-30
categories: kubernetes tls bootstrap
cover: 'assets/img/bootstrap.jpg'
tags: kubernetes TLS bootstrap
---

在搭建kubernetes时首先会给各个组件创建证书，但是在整个过程中并没有给kubelet组件单独创建证书。这是因为kubelet组件是安装在每个node节点上的，kubernetes管理员不可能给每个node节点都单独创建一个证书，而是通过bootstrap引导的方式自动给kubelet签发证书。具体是怎么实现的，本文将要探讨这一话题。


### 1 临时token
首先在master上要有个一个临时的token，这个token之所以是临时的，是因为token有个过期时间，默认是24小时，超过这个时间token就不可用。kubernetes中这个token以secret方式存储在etcd上。
创建临时token


```
cat <<EOF |kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  # Name MUST be of form "bootstrap-token-<token id>"
  name: bootstrap-token-${tokenid}
  namespace: kube-system

# Type MUST be 'bootstrap.kubernetes.io/token'
type: bootstrap.kubernetes.io/token
stringData:
  # Human readable description. Optional.
  description: "The default bootstrap token generated by 'kubeadm init'."

  # Token ID and secret. Required.
  token-id: '${tokenid}'
  token-secret: '${token-secret}'

  # Expiration. Optional.
  expiration: 2020-11-01T00:00:11Z

  # Allowed usages.
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"

  # Extra groups to authenticate the token as. Must start with "system:bootstrappers:"
  auth-extra-groups: system:bootstrappers:kubelet-bootstrap
EOF
```
>
name: 必须是bootstrap-token-${tokenid}这种格式<br>
type: 必须是bootstrap.kubernetes.io/token<br>
token-id: 一个6位的随机字符串 head -c 6 /dev/urandom | md5sum | head -c 6 <br>
token-secret: 一个16位的随机字符串  head -c 16 /dev/urandom | md5sum | head -c 16 <br>

执行上面的语句就可以生成一个关于临时token的secret

### 2 bootstrap配置文件

kubelet启动的时候如果没有找到kubelet.conf会根据--kubeconfig的值去读取boostrap-kubelet.conf文件,向apiserver发起csr请求，apiserver批准了kubelet的请求后会给kubelet签发证书，kubelet会在/etc/kubernetes目录下产生一个新的配置文件kubelet.conf，后期会根据这个新的配置文件和apiserver交互。apiserver签发的证书保存在/var/lib/kubelet/pki/kubelet-client-2020-09-25-17-05-46.pem ,并在/var/lib/kubelet/pki目录里通过一个软链kubelet-client-current.pem，连接到kubelet-client-2020-09-25-17-05-46.pem

```
kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.crt --embed-certs=true --server=https://${master_ip}:6443 --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf
kubectl config set-credentials kubelet-bootstrap --token=${tokenid}.${token-secret} --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf
kubectl config set-context kubelet-bootstrap@kubernetes --cluster=kubernetes --user=kubelt-bootstrap --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf
kubectl config use-context kubelet-bootstrap@kubernetes --kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf
```

### 3 给system:bootstrap组授权
kubelet是以system:bootstrap:${token-id}用户的身份向apiserver发CSR请求的，system:bootstrap:${token-id} 是属于system:bootstrap组，默认情况下，system:bootstrap组是没有创建CSR权限的，需要手动给system:bootstrap组授权


将system:bootstrap组和system:node-bootstrapper 角色绑定，允许system:bootstrap组创建CSR。
```
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata: 
  name: allow-system:bootstrappers-create-csr
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:node-bootstrapper
  apiGroup: rbac.authorization.k8s.io
```


自动批准system:bootstrap组首次申请证书的CSR请求

```
cat <<EOF |kubectl apply -f -
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
rules:
- apiGroups: ["certificates.k8s.io"]
  resources: ["certificatesigningrequests/nodeclient"]
  verbs: ["create"]

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: node-client-auto-approve-csr
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient 
  apiGroup: rbac.authorization.k8s.io
EOF
```

自动批准 system:nodes 组用户更新 kubelet 自身与 apiserver 通讯证书的 CSR 请求

```
cat <<EOF |kubectl apply -f -
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: node-client-auto-renew-crt
subjects:
- kind: Group
  name: system:nodes
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
  apiGroup: rbac.authorization.k8s.io
EOF
```

自动批准 system:nodes 组用户更新 kubelet 10250 api 端口证书的 CSR 请求

```
cat <<EOF |kubectl apply -f -
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: node-server-auto-renew-crt
subjects:
- kind: Group
  name: system:nodes
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver
  apiGroup: rbac.authorization.k8s.io
EOF
```
